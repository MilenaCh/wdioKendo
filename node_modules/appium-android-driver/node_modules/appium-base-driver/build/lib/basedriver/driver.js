'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _mjsonwp = require('../mjsonwp');

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _commands = require('./commands');

var _commands2 = _interopRequireDefault(_commands);

var _helpers = require('./helpers');

var _helpers2 = _interopRequireDefault(_helpers);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _desiredCaps = require('./desired-caps');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var NEW_COMMAND_TIMEOUT_MS = 60 * 1000;

var BaseDriver = (function (_MobileJsonWireProtocol) {
  _inherits(BaseDriver, _MobileJsonWireProtocol);

  function BaseDriver() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
    var shouldValidateCaps = arguments.length <= 1 || arguments[1] === undefined ? true : arguments[1];

    _classCallCheck(this, BaseDriver);

    _get(Object.getPrototypeOf(BaseDriver.prototype), 'constructor', this).call(this);

    // setup state
    this.sessionId = null;
    this.opts = opts;
    this.caps = null;
    this.helpers = _helpers2['default'];

    // timeout initialization
    this.newCommandTimeoutMs = NEW_COMMAND_TIMEOUT_MS;
    this.implicitWaitMs = 0;

    this._constraints = _lodash2['default'].cloneDeep(_desiredCaps.desiredCapabilityConstraints);
    this.locatorStrategies = [];
    this.webLocatorStrategies = [];

    // use a custom tmp dir to avoid losing data and app when computer is
    // restarted
    this.opts.tmpDir = this.opts.tmpDir || process.env.APPIUM_TMP_DIR || _os2['default'].tmpDir();

    // base-driver internals
    this.curCommand = new _bluebird2['default'](function (r) {
      r();
    }); // see note in execute
    this.curCommandCancellable = new _bluebird2['default'](function (r) {
      r();
    }); // see note in execute
    this.shutdownUnexpectedly = false;
    this.noCommandTimer = null;
    this.shouldValidateCaps = shouldValidateCaps;
    // settings should be instantiated by implementing drivers
    this.settings = null;
    this.resetOnUnexpectedShutdown();

    // keeping track of initial opts
    this.initialOpts = _lodash2['default'].cloneDeep(this.opts);
  }

  /*
   * Initialize a new onUnexpectedShutdown promise, cancelling existing one.
   */

  _createClass(BaseDriver, [{
    key: 'resetOnUnexpectedShutdown',
    value: function resetOnUnexpectedShutdown() {
      var _this = this;

      if (this.onUnexpectedShutdown && !this.onUnexpectedShutdown.isFulfilled()) {
        this.onUnexpectedShutdown.cancel();
      }
      this.onUnexpectedShutdown = new _bluebird2['default'](function (resolve, reject) {
        _this.unexpectedShutdownDeferred = { resolve: resolve, reject: reject };
      }).cancellable();
      // noop handler to avoid warning.
      this.onUnexpectedShutdown['catch'](function () {});
    }

    // we only want subclasses to ever extend the contraints
  }, {
    key: 'sessionExists',

    // method required by MJSONWP in order to determine whether it should
    // respond with an invalid session response
    value: function sessionExists(sessionId) {
      if (!sessionId) return false;
      return sessionId === this.sessionId;
    }

    // method required by MJSONWP in order to determine if the command should
    // be proxied directly to the driver
  }, {
    key: 'driverForSession',
    value: function driverForSession() /*sessionId*/{
      return this;
    }
  }, {
    key: 'logExtraCaps',
    value: function logExtraCaps(caps) {
      var extraCaps = _lodash2['default'].difference(_lodash2['default'].keys(caps), _lodash2['default'].keys(this._constraints));
      if (extraCaps.length) {
        _logger2['default'].warn('The following capabilities were provided, but are not ' + ('recognized by appium: ' + extraCaps.join(', ') + '.'));
      }
    }
  }, {
    key: 'validateDesiredCaps',
    value: function validateDesiredCaps(caps) {
      if (!this.shouldValidateCaps) {
        return true;
      }

      // we validate on only caps that are not null or undefined so that if
      // someone sends in e.g. null they don't get a 'was not a string'
      // error; just count as though it weren't sent in at all
      var validationErrors = _desiredCaps.validator.validate(_lodash2['default'].pickBy(caps, _appiumSupport.util.hasValue), this._constraints, { fullMessages: false });

      if (validationErrors) {
        var message = 'The desiredCapabilities object was not valid for the ' + 'following reason(s):';
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = _getIterator(_lodash2['default'].toPairs(validationErrors)), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var _step$value = _slicedToArray(_step.value, 2);

            var attribute = _step$value[0];
            var reasons = _step$value[1];
            var _iteratorNormalCompletion2 = true;
            var _didIteratorError2 = false;
            var _iteratorError2 = undefined;

            try {
              for (var _iterator2 = _getIterator(reasons), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                var reason = _step2.value;

                message += ' ' + attribute + ' ' + reason + ',';
              }
            } catch (err) {
              _didIteratorError2 = true;
              _iteratorError2 = err;
            } finally {
              try {
                if (!_iteratorNormalCompletion2 && _iterator2['return']) {
                  _iterator2['return']();
                }
              } finally {
                if (_didIteratorError2) {
                  throw _iteratorError2;
                }
              }
            }
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }

        message = message.slice(0, -1) + '.';
        _logger2['default'].errorAndThrow(new _mjsonwp.errors.SessionNotCreatedError(message));
      }

      this.logExtraCaps(caps);

      return true;
    }

    // This is the main command handler for the driver. It wraps command
    // execution with timeout logic, checking that we have a valid session,
    // and ensuring that we execute commands one at a time. This method is called
    // by MJSONWP's express router.
  }, {
    key: 'executeCommand',
    value: function executeCommand(cmd) {
      for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
        args[_key - 1] = arguments[_key];
      }

      var nextCommand, res;
      return _regeneratorRuntime.async(function executeCommand$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // if we had a command timer running, clear it now that we're starting
            // a new command and so don't want to time out
            this.clearNewCommandTimeout();

            // if we don't have this command, it must not be implemented

            if (this[cmd]) {
              context$2$0.next = 3;
              break;
            }

            throw new _mjsonwp.errors.NotYetImplementedError();

          case 3:
            nextCommand = this.curCommand.then(function () {
              // if we unexpectedly shut down, we need to reject every command in
              // the queue before we actually try to run it
              if (_this2.shutdownUnexpectedly) {
                return _bluebird2['default'].reject(new _mjsonwp.errors.NoSuchDriverError('The driver was unexpectedly shut down!'));
              }
              // We also need to turn the command into a cancellable promise so if we
              // have an unexpected shutdown event, for example, we can cancel it from
              // outside, rejecting the current command immediately
              _this2.curCommandCancellable = new _bluebird2['default'](function (r) {
                r();
              }).then(function () {
                return _this2[cmd].apply(_this2, args);
              }).cancellable();
              return _this2.curCommandCancellable;
            });

            this.curCommand = nextCommand['catch'](function () {});
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(nextCommand);

          case 7:
            res = context$2$0.sent;

            // if we have set a new command timeout (which is the default), start a
            // timer once we've finished executing this command. If we don't clear
            // the timer (which is done when a new command comes in), we will trigger
            // automatic session deletion in this.onCommandTimeout. Of course we don't
            // want to trigger the timer when the user is shutting down the session
            // intentionally
            if (cmd !== 'deleteSession') {
              // reseting existing timeout
              this.startNewCommandTimeout();
            }

            return context$2$0.abrupt('return', res);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startUnexpectedShutdown',
    value: function startUnexpectedShutdown() {
      var err = arguments.length <= 0 || arguments[0] === undefined ? new _mjsonwp.errors.NoSuchDriverError('The driver was unexpectedly shut down!') : arguments[0];
      return _regeneratorRuntime.async(function startUnexpectedShutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.unexpectedShutdownDeferred.reject(err); // allow others to listen for this
            this.curCommandCancellable.cancel(err);
            this.shutdownUnexpectedly = true;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.deleteSession(this.sessionId));

          case 5:
            this.shutdownUnexpectedly = false;

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'validateLocatorStrategy',
    value: function validateLocatorStrategy(strategy) {
      var webContext = arguments.length <= 1 || arguments[1] === undefined ? false : arguments[1];

      var validStrategies = this.locatorStrategies;
      _logger2['default'].debug('Valid locator strategies for this request: ' + validStrategies.join(', '));

      if (webContext) {
        validStrategies = validStrategies.concat(this.webLocatorStrategies);
      }

      if (!_lodash2['default'].includes(validStrategies, strategy)) {
        throw new _mjsonwp.errors.InvalidSelectorError('Locator Strategy \'' + strategy + '\' is not supported for this session');
      }
    }

    /*
     * Restart the session with the original caps,
     * preserving the timeout config.
     */
  }, {
    key: 'reset',
    value: function reset() {
      var currentConfig, _arr, _i, property, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, _step3$value, key, value;

      return _regeneratorRuntime.async(function reset$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Resetting app mid-session');
            _logger2['default'].debug('Running generic full reset');

            // preserving state
            currentConfig = {};
            _arr = ['implicitWaitMs', 'newCommandTimeoutMs', 'sessionId', 'resetOnUnexpectedShutdown'];

            for (_i = 0; _i < _arr.length; _i++) {
              property = _arr[_i];

              currentConfig[property] = this[property];
            }

            // We also need to preserve the unexpected shutdown, and make sure it is not cancelled during reset.
            this.resetOnUnexpectedShutdown = function () {};

            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.deleteSession(this.sessionId));

          case 9:
            _logger2['default'].debug('Restarting app');
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.createSession(this.caps));

          case 12:
            context$2$0.prev = 12;
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 16;

            // always restore state.
            for (_iterator3 = _getIterator(_lodash2['default'].toPairs(currentConfig)); !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
              _step3$value = _slicedToArray(_step3.value, 2);
              key = _step3$value[0];
              value = _step3$value[1];

              this[key] = value;
            }
            context$2$0.next = 24;
            break;

          case 20:
            context$2$0.prev = 20;
            context$2$0.t0 = context$2$0['catch'](16);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t0;

          case 24:
            context$2$0.prev = 24;
            context$2$0.prev = 25;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 27:
            context$2$0.prev = 27;

            if (!_didIteratorError3) {
              context$2$0.next = 30;
              break;
            }

            throw _iteratorError3;

          case 30:
            return context$2$0.finish(27);

          case 31:
            return context$2$0.finish(24);

          case 32:
            return context$2$0.finish(12);

          case 33:
            this.clearNewCommandTimeout();

          case 34:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6,, 12, 33], [16, 20, 24, 32], [25,, 27, 31]]);
    }
  }, {
    key: 'getSwipeOptions',
    value: function getSwipeOptions(gestures) {
      var touchCount = arguments.length <= 1 || arguments[1] === undefined ? 1 : arguments[1];
      var startX, startY, endX, endY, duration, element, destElement, locResult, sizeResult, offsetX, offsetY, firstElLocation;
      return _regeneratorRuntime.async(function getSwipeOptions$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startX = this.helpers.getCoordDefault(gestures[0].options.x), startY = this.helpers.getCoordDefault(gestures[0].options.y), endX = this.helpers.getCoordDefault(gestures[2].options.x), endY = this.helpers.getCoordDefault(gestures[2].options.y), duration = this.helpers.getSwipeTouchDuration(gestures[1]), element = gestures[0].options.element, destElement = gestures[2].options.element || gestures[0].options.element;

            if (!_appiumSupport.util.hasValue(destElement)) {
              context$2$0.next = 18;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.getLocationInView(destElement));

          case 4:
            locResult = context$2$0.sent;
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(this.getSize(destElement));

          case 7:
            sizeResult = context$2$0.sent;
            offsetX = Math.abs(endX) < 1 && Math.abs(endX) > 0 ? sizeResult.width * endX : endX;
            offsetY = Math.abs(endY) < 1 && Math.abs(endY) > 0 ? sizeResult.height * endY : endY;

            endX = locResult.x + offsetX;
            endY = locResult.y + offsetY;
            // if the target element was provided, the coordinates for the destination need to be relative to it.

            if (!_appiumSupport.util.hasValue(element)) {
              context$2$0.next = 18;
              break;
            }

            context$2$0.next = 15;
            return _regeneratorRuntime.awrap(this.getLocationInView(element));

          case 15:
            firstElLocation = context$2$0.sent;

            endX -= firstElLocation.x;
            endY -= firstElLocation.y;

          case 18:
            return context$2$0.abrupt('return', { startX:
              // clients are responsible to use these options correctly
              startX, startY: startY, endX: endX, endY: endY, duration: duration, touchCount: touchCount, element: element });

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'proxyActive',
    value: function proxyActive() /* sessionId */{
      return false;
    }
  }, {
    key: 'getProxyAvoidList',
    value: function getProxyAvoidList() /* sessionId */{
      return [];
    }
  }, {
    key: 'canProxy',
    value: function canProxy() /* sessionId */{
      return false;
    }
  }, {
    key: 'desiredCapConstraints',
    set: function set(constraints) {
      this._constraints = _Object$assign(this._constraints, constraints);
    },
    get: function get() {
      return this._constraints;
    }
  }]);

  return BaseDriver;
})(_mjsonwp.MobileJsonWireProtocol);

var _iteratorNormalCompletion4 = true;
var _didIteratorError4 = false;
var _iteratorError4 = undefined;

try {

  for (var _iterator4 = _getIterator(_lodash2['default'].toPairs(_commands2['default'])), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
    var _step4$value = _slicedToArray(_step4.value, 2);

    var cmd = _step4$value[0];
    var fn = _step4$value[1];

    BaseDriver.prototype[cmd] = fn;
  }
} catch (err) {
  _didIteratorError4 = true;
  _iteratorError4 = err;
} finally {
  try {
    if (!_iteratorNormalCompletion4 && _iterator4['return']) {
      _iterator4['return']();
    }
  } finally {
    if (_didIteratorError4) {
      throw _iteratorError4;
    }
  }
}

exports['default'] = BaseDriver;
module.exports = exports['default'];

// What we're doing here is pretty clever. this.curCommand is always
// a promise representing the command currently being executed by the
// driver, or the last command executed by the driver (it starts off as
// essentially a pre-resolved promise). When a command comes in, we tack it
// to the end of this.curCommand, essentially saying we want to execute it
// whenever this.curCommand is done. We call this new promise nextCommand,
// and its resolution is what we ultimately will return to whomever called
// us. Meanwhile, we reset this.curCommand to _be_ nextCommand (but
// ignoring any rejections), so that if another command comes into the
// server, it gets tacked on to the end of nextCommand. Thus we create
// a chain of promises that acts as a queue with single concurrency.

// there's no destination element handling in bootstrap and since it applies to all platforms, we handle it here
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2RyaXZlci5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7dUJBQ3VCLFlBQVk7O2tCQUNwQixJQUFJOzs7O3dCQUNFLFlBQVk7Ozs7dUJBQ2IsV0FBVzs7OztzQkFDZixVQUFVOzs7OzJCQUM4QixnQkFBZ0I7O3dCQUMxRCxVQUFVOzs7O3NCQUNWLFFBQVE7Ozs7NkJBQ0QsZ0JBQWdCOztBQUdyQyxJQUFNLHNCQUFzQixHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUM7O0lBRW5DLFVBQVU7WUFBVixVQUFVOztBQUVGLFdBRlIsVUFBVSxHQUVxQztRQUF0QyxJQUFJLHlEQUFHLEVBQUU7UUFBRSxrQkFBa0IseURBQUcsSUFBSTs7MEJBRjdDLFVBQVU7O0FBR1osK0JBSEUsVUFBVSw2Q0FHSjs7O0FBR1IsUUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDdEIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7QUFDakIsUUFBSSxDQUFDLE9BQU8sdUJBQVUsQ0FBQzs7O0FBR3ZCLFFBQUksQ0FBQyxtQkFBbUIsR0FBRyxzQkFBc0IsQ0FBQztBQUNsRCxRQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQzs7QUFFeEIsUUFBSSxDQUFDLFlBQVksR0FBRyxvQkFBRSxTQUFTLDJDQUE4QixDQUFDO0FBQzlELFFBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7QUFDNUIsUUFBSSxDQUFDLG9CQUFvQixHQUFHLEVBQUUsQ0FBQzs7OztBQUkvQixRQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQzFCLGdCQUFHLE1BQU0sRUFBRSxDQUFDOzs7QUFHL0IsUUFBSSxDQUFDLFVBQVUsR0FBRywwQkFBTSxVQUFD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QWUsQ0FBQyxDQUFDLENBQUM7QUFDMUIsZ0JBQUksSUFBSSxlQUFlLENBQUMsQ0FBQyxDQUFDOzs7Z0RBSXZCLEVBQUMsTUFBTTs7QUFBTixvQkFBTSxFQUFFLE1BQU0sRUFBTixNQUFNLEVBQUUsSUFBSSxFQUFKLElBQUksRUFBRSxJQUFJLEVBQUosSUFBSSxFQUFFLFFBQVEsRUFBUixRQUFRLEVBQUUsVUFBVSxFQUFWLFVBQVUsRUFBRSxPQUFPLEVBQVAsT0FBTyxFQUFDOzs7Ozs7O0tBQ25FOzs7V0FFVyxzQ0FBa0I7QUFDNUIsYUFBTyxLQUFLLENBQUM7S0FDZDs7O1dBRWlCLDRDQUFrQjtBQUNsQyxhQUFPLEVBQUUsQ0FBQztLQUNYOzs7V0FFUSxtQ0FBa0I7QUFDekIsYUFBTyxLQUFLLENBQUM7S0FDZDs7O1NBNU15QixhQUFDLFdBQVcsRUFBRTtBQUN0QyxVQUFJLENBQUMsWUFBWSxHQUFHLGVBQWMsSUFBSSxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQztLQUNuRTtTQUV5QixlQUFHO0FBQzNCLGFBQU8sSUFBSSxDQUFDLFlBQVksQ0FBQztLQUMxQjs7O1NBNURHLFVBQVU7Ozs7Ozs7OztBQXFRaEIscUNBQXNCLG9CQUFFLE9BQU8sdUJBQVUsaUhBQUU7OztRQUFqQyxHQUFHO1FBQUUsRUFBRTs7QUFDZixjQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztHQUNoQzs7Ozs7Ozs7Ozs7Ozs7OztxQkFFYyxVQUFVIiwiZmlsZSI6ImxpYi9iYXNlZHJpdmVyL2RyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vYmlsZUpzb25XaXJlUHJvdG9jb2wsXG4gICAgICAgICBlcnJvcnMgfSBmcm9tICcuLi9tanNvbndwJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgY29tbWFuZHMgZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgaGVscGVycyBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBkZXNpcmVkQ2FwYWJpbGl0eUNvbnN0cmFpbnRzLCB2YWxpZGF0b3IgfSBmcm9tICcuL2Rlc2lyZWQtY2Fwcyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5jb25zdCBORVdfQ09NTUFORF9USU1FT1VUX01TID0gNjAgKiAxMDAwO1xuXG5jbGFzcyBCYXNlRHJpdmVyIGV4dGVuZHMgTW9iaWxlSnNvbldpcmVQcm90b2NvbCB7XG5cbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSwgc2hvdWxkVmFsaWRhdGVDYXBzID0gdHJ1ZSkge1xuICAgIHN1cGVyKCk7XG5cbiAgICAvLyBzZXR1cCBzdGF0ZVxuICAgIHRoaXMuc2Vzc2lvbklkID0gbnVsbDtcbiAgICB0aGlzLm9wdHMgPSBvcHRzO1xuICAgIHRoaXMuY2FwcyA9IG51bGw7XG4gICAgdGhpcy5oZWxwZXJzID0gaGVscGVycztcblxuICAgIC8vIHRpbWVvdXQgaW5pdGlhbGl6YXRpb25cbiAgICB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSBORVdfQ09NTUFORF9USU1FT1VUX01TO1xuICAgIHRoaXMuaW1wbGljaXRXYWl0TXMgPSAwO1xuXG4gICAgdGhpcy5fY29uc3RyYWludHMgPSBfLmNsb25lRGVlcChkZXNpcmVkQ2FwYWJpbGl0eUNvbnN0cmFpbnRzKTtcbiAgICB0aGlzLmxvY2F0b3JTdHJhdGVnaWVzID0gW107XG4gICAgdGhpcy53ZWJMb2NhdG9yU3RyYXRlZ2llcyA9IFtdO1xuXG4gICAgLy8gdXNlIGEgY3VzdG9tIHRtcCBkaXIgdG8gYXZvaWQgbG9zaW5nIGRhdGEgYW5kIGFwcCB3aGVuIGNvbXB1dGVyIGlzXG4gICAgLy8gcmVzdGFydGVkXG4gICAgdGhpcy5vcHRzLnRtcERpciA9IHRoaXMub3B0cy50bXBEaXIgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuQVBQSVVNX1RNUF9ESVIgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgb3MudG1wRGlyKCk7XG5cbiAgICAvLyBiYXNlLWRyaXZlciBpbnRlcm5hbHNcbiAgICB0aGlzLmN1ckNvbW1hbmQgPSBuZXcgQigocikgPT4geyByKCk7IH0pOyAvLyBzZWUgbm90ZSBpbiBleGVjdXRlXG4gICAgdGhpcy5jdXJDb21tYW5kQ2FuY2VsbGFibGUgPSBuZXcgQigocikgPT4geyByKCk7IH0pOyAvLyBzZWUgbm90ZSBpbiBleGVjdXRlXG4gICAgdGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSA9IGZhbHNlO1xuICAgIHRoaXMubm9Db21tYW5kVGltZXIgPSBudWxsO1xuICAgIHRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzID0gc2hvdWxkVmFsaWRhdGVDYXBzO1xuICAgIC8vIHNldHRpbmdzIHNob3VsZCBiZSBpbnN0YW50aWF0ZWQgYnkgaW1wbGVtZW50aW5nIGRyaXZlcnNcbiAgICB0aGlzLnNldHRpbmdzID0gbnVsbDtcbiAgICB0aGlzLnJlc2V0T25VbmV4cGVjdGVkU2h1dGRvd24oKTtcblxuICAgIC8vIGtlZXBpbmcgdHJhY2sgb2YgaW5pdGlhbCBvcHRzXG4gICAgdGhpcy5pbml0aWFsT3B0cyA9IF8uY2xvbmVEZWVwKHRoaXMub3B0cyk7XG4gIH1cblxuICAvKlxuICAgKiBJbml0aWFsaXplIGEgbmV3IG9uVW5leHBlY3RlZFNodXRkb3duIHByb21pc2UsIGNhbmNlbGxpbmcgZXhpc3Rpbmcgb25lLlxuICAgKi9cbiAgcmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93bigpIHtcbiAgICBpZiAodGhpcy5vblVuZXhwZWN0ZWRTaHV0ZG93biAmJiAhdGhpcy5vblVuZXhwZWN0ZWRTaHV0ZG93bi5pc0Z1bGZpbGxlZCgpKSB7XG4gICAgICB0aGlzLm9uVW5leHBlY3RlZFNodXRkb3duLmNhbmNlbCgpO1xuICAgIH1cbiAgICB0aGlzLm9uVW5leHBlY3RlZFNodXRkb3duID0gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy51bmV4cGVjdGVkU2h1dGRvd25EZWZlcnJlZCAgPSB7cmVzb2x2ZSwgcmVqZWN0fTtcbiAgICB9KS5jYW5jZWxsYWJsZSgpO1xuICAgIC8vIG5vb3AgaGFuZGxlciB0byBhdm9pZCB3YXJuaW5nLlxuICAgIHRoaXMub25VbmV4cGVjdGVkU2h1dGRvd24uY2F0Y2goKCkgPT4ge30pO1xuICB9XG5cbiAgLy8gd2Ugb25seSB3YW50IHN1YmNsYXNzZXMgdG8gZXZlciBleHRlbmQgdGhlIGNvbnRyYWludHNcbiAgc2V0IGRlc2lyZWRDYXBDb25zdHJhaW50cyAoY29uc3RyYWludHMpIHtcbiAgICB0aGlzLl9jb25zdHJhaW50cyA9IE9iamVjdC5hc3NpZ24odGhpcy5fY29uc3RyYWludHMsIGNvbnN0cmFpbnRzKTtcbiAgfVxuXG4gIGdldCBkZXNpcmVkQ2FwQ29uc3RyYWludHMgKCkge1xuICAgIHJldHVybiB0aGlzLl9jb25zdHJhaW50cztcbiAgfVxuXG4gIC8vIG1ldGhvZCByZXF1aXJlZCBieSBNSlNPTldQIGluIG9yZGVyIHRvIGRldGVybWluZSB3aGV0aGVyIGl0IHNob3VsZFxuICAvLyByZXNwb25kIHdpdGggYW4gaW52YWxpZCBzZXNzaW9uIHJlc3BvbnNlXG4gIHNlc3Npb25FeGlzdHMgKHNlc3Npb25JZCkge1xuICAgIGlmICghc2Vzc2lvbklkKSByZXR1cm4gZmFsc2U7XG4gICAgcmV0dXJuIHNlc3Npb25JZCA9PT0gdGhpcy5zZXNzaW9uSWQ7XG4gIH1cblxuICAvLyBtZXRob2QgcmVxdWlyZWQgYnkgTUpTT05XUCBpbiBvcmRlciB0byBkZXRlcm1pbmUgaWYgdGhlIGNvbW1hbmQgc2hvdWxkXG4gIC8vIGJlIHByb3hpZWQgZGlyZWN0bHkgdG8gdGhlIGRyaXZlclxuICBkcml2ZXJGb3JTZXNzaW9uICgvKnNlc3Npb25JZCovKSB7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBsb2dFeHRyYUNhcHMgKGNhcHMpIHtcbiAgICBsZXQgZXh0cmFDYXBzID0gXy5kaWZmZXJlbmNlKF8ua2V5cyhjYXBzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8ua2V5cyh0aGlzLl9jb25zdHJhaW50cykpO1xuICAgIGlmIChleHRyYUNhcHMubGVuZ3RoKSB7XG4gICAgICBsb2cud2FybihgVGhlIGZvbGxvd2luZyBjYXBhYmlsaXRpZXMgd2VyZSBwcm92aWRlZCwgYnV0IGFyZSBub3QgYCArXG4gICAgICAgICAgICAgICBgcmVjb2duaXplZCBieSBhcHBpdW06ICR7ZXh0cmFDYXBzLmpvaW4oJywgJyl9LmApO1xuICAgIH1cbiAgfVxuXG4gIHZhbGlkYXRlRGVzaXJlZENhcHMgKGNhcHMpIHtcbiAgICBpZiAoIXRoaXMuc2hvdWxkVmFsaWRhdGVDYXBzKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyB3ZSB2YWxpZGF0ZSBvbiBvbmx5IGNhcHMgdGhhdCBhcmUgbm90IG51bGwgb3IgdW5kZWZpbmVkIHNvIHRoYXQgaWZcbiAgICAvLyBzb21lb25lIHNlbmRzIGluIGUuZy4gbnVsbCB0aGV5IGRvbid0IGdldCBhICd3YXMgbm90IGEgc3RyaW5nJ1xuICAgIC8vIGVycm9yOyBqdXN0IGNvdW50IGFzIHRob3VnaCBpdCB3ZXJlbid0IHNlbnQgaW4gYXQgYWxsXG4gICAgbGV0IHZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0b3IudmFsaWRhdGUoXy5waWNrQnkoY2FwcywgdXRpbC5oYXNWYWx1ZSksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fY29uc3RyYWludHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge2Z1bGxNZXNzYWdlczogZmFsc2V9KTtcblxuICAgIGlmICh2YWxpZGF0aW9uRXJyb3JzKSB7XG4gICAgICBsZXQgbWVzc2FnZSA9IGBUaGUgZGVzaXJlZENhcGFiaWxpdGllcyBvYmplY3Qgd2FzIG5vdCB2YWxpZCBmb3IgdGhlIGAgK1xuICAgICAgICAgICAgICAgICAgICBgZm9sbG93aW5nIHJlYXNvbihzKTpgO1xuICAgICAgZm9yIChsZXQgW2F0dHJpYnV0ZSwgcmVhc29uc10gb2YgXy50b1BhaXJzKHZhbGlkYXRpb25FcnJvcnMpKSB7XG4gICAgICAgIGZvciAobGV0IHJlYXNvbiBvZiByZWFzb25zKSB7XG4gICAgICAgICAgbWVzc2FnZSArPSBgICR7YXR0cmlidXRlfSAke3JlYXNvbn0sYDtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgbWVzc2FnZSA9IGAke21lc3NhZ2Uuc2xpY2UoMCwgLTEpfS5gO1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3cobmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKG1lc3NhZ2UpKTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ0V4dHJhQ2FwcyhjYXBzKTtcblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLy8gVGhpcyBpcyB0aGUgbWFpbiBjb21tYW5kIGhhbmRsZXIgZm9yIHRoZSBkcml2ZXIuIEl0IHdyYXBzIGNvbW1hbmRcbiAgLy8gZXhlY3V0aW9uIHdpdGggdGltZW91dCBsb2dpYywgY2hlY2tpbmcgdGhhdCB3ZSBoYXZlIGEgdmFsaWQgc2Vzc2lvbixcbiAgLy8gYW5kIGVuc3VyaW5nIHRoYXQgd2UgZXhlY3V0ZSBjb21tYW5kcyBvbmUgYXQgYSB0aW1lLiBUaGlzIG1ldGhvZCBpcyBjYWxsZWRcbiAgLy8gYnkgTUpTT05XUCdzIGV4cHJlc3Mgcm91dGVyLlxuICBhc3luYyBleGVjdXRlQ29tbWFuZCAoY21kLCAuLi5hcmdzKSB7XG4gICAgLy8gaWYgd2UgaGFkIGEgY29tbWFuZCB0aW1lciBydW5uaW5nLCBjbGVhciBpdCBub3cgdGhhdCB3ZSdyZSBzdGFydGluZ1xuICAgIC8vIGEgbmV3IGNvbW1hbmQgYW5kIHNvIGRvbid0IHdhbnQgdG8gdGltZSBvdXRcbiAgICB0aGlzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQoKTtcblxuICAgIC8vIGlmIHdlIGRvbid0IGhhdmUgdGhpcyBjb21tYW5kLCBpdCBtdXN0IG5vdCBiZSBpbXBsZW1lbnRlZFxuICAgIGlmICghdGhpc1tjbWRdKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vdFlldEltcGxlbWVudGVkRXJyb3IoKTtcbiAgICB9XG5cbiAgICAvLyBXaGF0IHdlJ3JlIGRvaW5nIGhlcmUgaXMgcHJldHR5IGNsZXZlci4gdGhpcy5jdXJDb21tYW5kIGlzIGFsd2F5c1xuICAgIC8vIGEgcHJvbWlzZSByZXByZXNlbnRpbmcgdGhlIGNvbW1hbmQgY3VycmVudGx5IGJlaW5nIGV4ZWN1dGVkIGJ5IHRoZVxuICAgIC8vIGRyaXZlciwgb3IgdGhlIGxhc3QgY29tbWFuZCBleGVjdXRlZCBieSB0aGUgZHJpdmVyIChpdCBzdGFydHMgb2ZmIGFzXG4gICAgLy8gZXNzZW50aWFsbHkgYSBwcmUtcmVzb2x2ZWQgcHJvbWlzZSkuIFdoZW4gYSBjb21tYW5kIGNvbWVzIGluLCB3ZSB0YWNrIGl0XG4gICAgLy8gdG8gdGhlIGVuZCBvZiB0aGlzLmN1ckNvbW1hbmQsIGVzc2VudGlhbGx5IHNheWluZyB3ZSB3YW50IHRvIGV4ZWN1dGUgaXRcbiAgICAvLyB3aGVuZXZlciB0aGlzLmN1ckNvbW1hbmQgaXMgZG9uZS4gV2UgY2FsbCB0aGlzIG5ldyBwcm9taXNlIG5leHRDb21tYW5kLFxuICAgIC8vIGFuZCBpdHMgcmVzb2x1dGlvbiBpcyB3aGF0IHdlIHVsdGltYXRlbHkgd2lsbCByZXR1cm4gdG8gd2hvbWV2ZXIgY2FsbGVkXG4gICAgLy8gdXMuIE1lYW53aGlsZSwgd2UgcmVzZXQgdGhpcy5jdXJDb21tYW5kIHRvIF9iZV8gbmV4dENvbW1hbmQgKGJ1dFxuICAgIC8vIGlnbm9yaW5nIGFueSByZWplY3Rpb25zKSwgc28gdGhhdCBpZiBhbm90aGVyIGNvbW1hbmQgY29tZXMgaW50byB0aGVcbiAgICAvLyBzZXJ2ZXIsIGl0IGdldHMgdGFja2VkIG9uIHRvIHRoZSBlbmQgb2YgbmV4dENvbW1hbmQuIFRodXMgd2UgY3JlYXRlXG4gICAgLy8gYSBjaGFpbiBvZiBwcm9taXNlcyB0aGF0IGFjdHMgYXMgYSBxdWV1ZSB3aXRoIHNpbmdsZSBjb25jdXJyZW5jeS5cbiAgICBsZXQgbmV4dENvbW1hbmQgPSB0aGlzLmN1ckNvbW1hbmQudGhlbigoKSA9PiB7XG4gICAgICAvLyBpZiB3ZSB1bmV4cGVjdGVkbHkgc2h1dCBkb3duLCB3ZSBuZWVkIHRvIHJlamVjdCBldmVyeSBjb21tYW5kIGluXG4gICAgICAvLyB0aGUgcXVldWUgYmVmb3JlIHdlIGFjdHVhbGx5IHRyeSB0byBydW4gaXRcbiAgICAgIGlmICh0aGlzLnNodXRkb3duVW5leHBlY3RlZGx5KSB7XG4gICAgICAgIHJldHVybiBCLnJlamVjdChuZXcgZXJyb3JzLk5vU3VjaERyaXZlckVycm9yKCdUaGUgZHJpdmVyIHdhcyB1bmV4cGVjdGVkbHkgc2h1dCBkb3duIScpKTtcbiAgICAgIH1cbiAgICAgIC8vIFdlIGFsc28gbmVlZCB0byB0dXJuIHRoZSBjb21tYW5kIGludG8gYSBjYW5jZWxsYWJsZSBwcm9taXNlIHNvIGlmIHdlXG4gICAgICAvLyBoYXZlIGFuIHVuZXhwZWN0ZWQgc2h1dGRvd24gZXZlbnQsIGZvciBleGFtcGxlLCB3ZSBjYW4gY2FuY2VsIGl0IGZyb21cbiAgICAgIC8vIG91dHNpZGUsIHJlamVjdGluZyB0aGUgY3VycmVudCBjb21tYW5kIGltbWVkaWF0ZWx5XG4gICAgICB0aGlzLmN1ckNvbW1hbmRDYW5jZWxsYWJsZSA9IG5ldyBCKChyKSA9PiB7IHIoKTsgfSkudGhlbigoKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzW2NtZF0oLi4uYXJncyk7XG4gICAgICB9KS5jYW5jZWxsYWJsZSgpO1xuICAgICAgcmV0dXJuIHRoaXMuY3VyQ29tbWFuZENhbmNlbGxhYmxlO1xuICAgIH0pO1xuICAgIHRoaXMuY3VyQ29tbWFuZCA9IG5leHRDb21tYW5kLmNhdGNoKCgpID0+IHt9KTtcbiAgICBsZXQgcmVzID0gYXdhaXQgbmV4dENvbW1hbmQ7XG5cbiAgICAvLyBpZiB3ZSBoYXZlIHNldCBhIG5ldyBjb21tYW5kIHRpbWVvdXQgKHdoaWNoIGlzIHRoZSBkZWZhdWx0KSwgc3RhcnQgYVxuICAgIC8vIHRpbWVyIG9uY2Ugd2UndmUgZmluaXNoZWQgZXhlY3V0aW5nIHRoaXMgY29tbWFuZC4gSWYgd2UgZG9uJ3QgY2xlYXJcbiAgICAvLyB0aGUgdGltZXIgKHdoaWNoIGlzIGRvbmUgd2hlbiBhIG5ldyBjb21tYW5kIGNvbWVzIGluKSwgd2Ugd2lsbCB0cmlnZ2VyXG4gICAgLy8gYXV0b21hdGljIHNlc3Npb24gZGVsZXRpb24gaW4gdGhpcy5vbkNvbW1hbmRUaW1lb3V0LiBPZiBjb3Vyc2Ugd2UgZG9uJ3RcbiAgICAvLyB3YW50IHRvIHRyaWdnZXIgdGhlIHRpbWVyIHdoZW4gdGhlIHVzZXIgaXMgc2h1dHRpbmcgZG93biB0aGUgc2Vzc2lvblxuICAgIC8vIGludGVudGlvbmFsbHlcbiAgICBpZiAoY21kICE9PSAnZGVsZXRlU2Vzc2lvbicpIHtcbiAgICAgIC8vIHJlc2V0aW5nIGV4aXN0aW5nIHRpbWVvdXRcbiAgICAgIHRoaXMuc3RhcnROZXdDb21tYW5kVGltZW91dCgpO1xuICAgIH1cblxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBhc3luYyBzdGFydFVuZXhwZWN0ZWRTaHV0ZG93biAoZXJyID0gbmV3IGVycm9ycy5Ob1N1Y2hEcml2ZXJFcnJvcignVGhlIGRyaXZlciB3YXMgdW5leHBlY3RlZGx5IHNodXQgZG93biEnKSkge1xuICAgIHRoaXMudW5leHBlY3RlZFNodXRkb3duRGVmZXJyZWQucmVqZWN0KGVycik7IC8vIGFsbG93IG90aGVycyB0byBsaXN0ZW4gZm9yIHRoaXNcbiAgICB0aGlzLmN1ckNvbW1hbmRDYW5jZWxsYWJsZS5jYW5jZWwoZXJyKTtcbiAgICB0aGlzLnNodXRkb3duVW5leHBlY3RlZGx5ID0gdHJ1ZTtcbiAgICBhd2FpdCB0aGlzLmRlbGV0ZVNlc3Npb24odGhpcy5zZXNzaW9uSWQpO1xuICAgIHRoaXMuc2h1dGRvd25VbmV4cGVjdGVkbHkgPSBmYWxzZTtcbiAgfVxuXG4gIHZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IChzdHJhdGVneSwgd2ViQ29udGV4dCA9IGZhbHNlKSB7XG4gICAgbGV0IHZhbGlkU3RyYXRlZ2llcyA9IHRoaXMubG9jYXRvclN0cmF0ZWdpZXM7XG4gICAgbG9nLmRlYnVnKGBWYWxpZCBsb2NhdG9yIHN0cmF0ZWdpZXMgZm9yIHRoaXMgcmVxdWVzdDogJHt2YWxpZFN0cmF0ZWdpZXMuam9pbignLCAnKX1gKTtcblxuICAgIGlmICh3ZWJDb250ZXh0KSB7XG4gICAgICB2YWxpZFN0cmF0ZWdpZXMgPSB2YWxpZFN0cmF0ZWdpZXMuY29uY2F0KHRoaXMud2ViTG9jYXRvclN0cmF0ZWdpZXMpO1xuICAgIH1cblxuICAgIGlmICghXy5pbmNsdWRlcyh2YWxpZFN0cmF0ZWdpZXMsIHN0cmF0ZWd5KSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5JbnZhbGlkU2VsZWN0b3JFcnJvcihgTG9jYXRvciBTdHJhdGVneSAnJHtzdHJhdGVneX0nIGlzIG5vdCBzdXBwb3J0ZWQgZm9yIHRoaXMgc2Vzc2lvbmApO1xuICAgIH1cbiAgfVxuXG4gIC8qXG4gICAqIFJlc3RhcnQgdGhlIHNlc3Npb24gd2l0aCB0aGUgb3JpZ2luYWwgY2FwcyxcbiAgICogcHJlc2VydmluZyB0aGUgdGltZW91dCBjb25maWcuXG4gICAqL1xuICBhc3luYyByZXNldCAoKSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldHRpbmcgYXBwIG1pZC1zZXNzaW9uJyk7XG4gICAgbG9nLmRlYnVnKCdSdW5uaW5nIGdlbmVyaWMgZnVsbCByZXNldCcpO1xuXG4gICAgLy8gcHJlc2VydmluZyBzdGF0ZVxuICAgIGxldCBjdXJyZW50Q29uZmlnID0ge307XG4gICAgZm9yIChsZXQgcHJvcGVydHkgb2YgWydpbXBsaWNpdFdhaXRNcycsICduZXdDb21tYW5kVGltZW91dE1zJywgJ3Nlc3Npb25JZCcsICdyZXNldE9uVW5leHBlY3RlZFNodXRkb3duJ10pIHtcbiAgICAgIGN1cnJlbnRDb25maWdbcHJvcGVydHldID0gdGhpc1twcm9wZXJ0eV07XG4gICAgfVxuXG4gICAgLy8gV2UgYWxzbyBuZWVkIHRvIHByZXNlcnZlIHRoZSB1bmV4cGVjdGVkIHNodXRkb3duLCBhbmQgbWFrZSBzdXJlIGl0IGlzIG5vdCBjYW5jZWxsZWQgZHVyaW5nIHJlc2V0LlxuICAgIHRoaXMucmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biA9ICgpID0+IHt9O1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuZGVsZXRlU2Vzc2lvbih0aGlzLnNlc3Npb25JZCk7XG4gICAgICBsb2cuZGVidWcoJ1Jlc3RhcnRpbmcgYXBwJyk7XG4gICAgICBhd2FpdCB0aGlzLmNyZWF0ZVNlc3Npb24odGhpcy5jYXBzKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgLy8gYWx3YXlzIHJlc3RvcmUgc3RhdGUuXG4gICAgICBmb3IgKGxldCBba2V5LCB2YWx1ZV0gb2YgXy50b1BhaXJzKGN1cnJlbnRDb25maWcpKSB7XG4gICAgICAgIHRoaXNba2V5XSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQoKTtcbiAgfVxuXG4gIGFzeW5jIGdldFN3aXBlT3B0aW9ucyAoZ2VzdHVyZXMsIHRvdWNoQ291bnQgPSAxKSB7XG4gICAgbGV0IHN0YXJ0WCA9ICB0aGlzLmhlbHBlcnMuZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzBdLm9wdGlvbnMueCksXG4gICAgICBzdGFydFkgPSB0aGlzLmhlbHBlcnMuZ2V0Q29vcmREZWZhdWx0KGdlc3R1cmVzWzBdLm9wdGlvbnMueSksXG4gICAgICBlbmRYID0gdGhpcy5oZWxwZXJzLmdldENvb3JkRGVmYXVsdChnZXN0dXJlc1syXS5vcHRpb25zLngpLFxuICAgICAgZW5kWSA9IHRoaXMuaGVscGVycy5nZXRDb29yZERlZmF1bHQoZ2VzdHVyZXNbMl0ub3B0aW9ucy55KSxcbiAgICAgIGR1cmF0aW9uID0gdGhpcy5oZWxwZXJzLmdldFN3aXBlVG91Y2hEdXJhdGlvbihnZXN0dXJlc1sxXSksXG4gICAgICBlbGVtZW50ID0gZ2VzdHVyZXNbMF0ub3B0aW9ucy5lbGVtZW50LFxuICAgICAgZGVzdEVsZW1lbnQgPSBnZXN0dXJlc1syXS5vcHRpb25zLmVsZW1lbnQgfHwgZ2VzdHVyZXNbMF0ub3B0aW9ucy5lbGVtZW50O1xuXG4gICAgLy8gdGhlcmUncyBubyBkZXN0aW5hdGlvbiBlbGVtZW50IGhhbmRsaW5nIGluIGJvb3RzdHJhcCBhbmQgc2luY2UgaXQgYXBwbGllcyB0byBhbGwgcGxhdGZvcm1zLCB3ZSBoYW5kbGUgaXQgaGVyZVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKGRlc3RFbGVtZW50KSkge1xuICAgICAgbGV0IGxvY1Jlc3VsdCA9IGF3YWl0IHRoaXMuZ2V0TG9jYXRpb25JblZpZXcoZGVzdEVsZW1lbnQpO1xuICAgICAgbGV0IHNpemVSZXN1bHQgPSBhd2FpdCB0aGlzLmdldFNpemUoZGVzdEVsZW1lbnQpO1xuICAgICAgbGV0IG9mZnNldFggPSAoTWF0aC5hYnMoZW5kWCkgPCAxICYmIE1hdGguYWJzKGVuZFgpID4gMCkgPyBzaXplUmVzdWx0LndpZHRoICogZW5kWCA6IGVuZFg7XG4gICAgICBsZXQgb2Zmc2V0WSA9IChNYXRoLmFicyhlbmRZKSA8IDEgJiYgTWF0aC5hYnMoZW5kWSkgPiAwKSA/IHNpemVSZXN1bHQuaGVpZ2h0ICogZW5kWSA6IGVuZFk7XG4gICAgICBlbmRYID0gbG9jUmVzdWx0LnggKyBvZmZzZXRYO1xuICAgICAgZW5kWSA9IGxvY1Jlc3VsdC55ICsgb2Zmc2V0WTtcbiAgICAgIC8vIGlmIHRoZSB0YXJnZXQgZWxlbWVudCB3YXMgcHJvdmlkZWQsIHRoZSBjb29yZGluYXRlcyBmb3IgdGhlIGRlc3RpbmF0aW9uIG5lZWQgdG8gYmUgcmVsYXRpdmUgdG8gaXQuXG4gICAgICBpZiAodXRpbC5oYXNWYWx1ZShlbGVtZW50KSkge1xuICAgICAgICBsZXQgZmlyc3RFbExvY2F0aW9uID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhlbGVtZW50KTtcbiAgICAgICAgZW5kWCAtPSBmaXJzdEVsTG9jYXRpb24ueDtcbiAgICAgICAgZW5kWSAtPSBmaXJzdEVsTG9jYXRpb24ueTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gY2xpZW50cyBhcmUgcmVzcG9uc2libGUgdG8gdXNlIHRoZXNlIG9wdGlvbnMgY29ycmVjdGx5XG4gICAgcmV0dXJuIHtzdGFydFgsIHN0YXJ0WSwgZW5kWCwgZW5kWSwgZHVyYXRpb24sIHRvdWNoQ291bnQsIGVsZW1lbnR9O1xuICB9XG5cbiAgcHJveHlBY3RpdmUgKC8qIHNlc3Npb25JZCAqLykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGdldFByb3h5QXZvaWRMaXN0ICgvKiBzZXNzaW9uSWQgKi8pIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjYW5Qcm94eSAoLyogc2Vzc2lvbklkICovKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmZvciAobGV0IFtjbWQsIGZuXSBvZiBfLnRvUGFpcnMoY29tbWFuZHMpKSB7XG4gIEJhc2VEcml2ZXIucHJvdG90eXBlW2NtZF0gPSBmbjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgQmFzZURyaXZlcjtcbiJdfQ==